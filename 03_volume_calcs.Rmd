---
title: "03_volume_calcs"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

# Pull in the munged lake height and lake area data

```{r}
areas <- read_csv('data/out/areas_munged_CC30.csv') %>%
  select(area = Reconstructed, sat, name, date = timestamp) %>%
  mutate(date = as_date(date),
         areaID = row_number()) %>%
  group_by(name, date) %>%
  summarise(area = mean(area)) %>%
  ungroup()

heights <- read_csv('data/out/heights_munged.csv') %>%
  select(height, name = name.std, date)

lake.summaries <- read_csv('data/in/lake_properties.csv') %>%
  distinct(name,.keep_all = T)

```

## Find matchups (+/- 1 day pairs)

```{r}
sameday <- areas %>% inner_join(heights) %>%
  group_by(name, date) %>%
  summarise(area = mean(area),
         height = mean(height)) %>%
  mutate(obID = paste0(date,"_",name)) %>%
  ungroup()

plusone <- areas %>%
  mutate(area_date = date,
         date = date + 1) %>%
  inner_join(heights) %>%
  group_by(name, date) %>%
  summarise(area = mean(area),
         height = mean(height)) %>%
  mutate(obID = paste0(date,"_",name)) %>%
  ungroup()

minusone <- areas %>%
  mutate(area_date = date,
         date = date - 1) %>%
  inner_join(heights) %>%
  group_by(name, date) %>%
  summarise(area = mean(area),
         height = mean(height)) %>%
  mutate(obID = paste0(date,"_",name)) %>%
  ungroup()

## We prefer same day,
plusone <- plusone %>% filter(!obID %in% sameday$obID)
minusone <- minusone %>% filter(!obID %in% sameday$obID)

## Check for obs both in both plus and minus and average them
overlap <- plusone %>% filter(obID %in% minusone$obID) %>%
  group_by(name, date, obID) %>%
  summarise(height = mean(height),
            area = mean(area))

matchups <- sameday %>% mutate(matchup = 'same') %>%
  bind_rows(plusone %>% filter(!obID %in% overlap$obID) %>% mutate(matchup = 'plusone')) %>%
  bind_rows(minusone %>% filter(!obID %in% overlap$obID) %>% mutate(matchup = 'minusone')) %>%
  bind_rows(overlap %>% mutate(matchup = 'average')) %>%
  mutate(area_m = area*1000000)


## This leaves us with only 77 lakes where there is at least 1 matchup
dplyr::count(matchups,name) %>% filter(n>2)
## and 60 lakes with at least 3

```

## Calculate volume changes

```{r}

## Simple volumetric change based on trapezoidal volume
volChange <- function(lake){

  date.first <- lake[lake$date == min(lake$date),]
  
  lake %>% arrange(date) %>%
    mutate(area_diff = area_m + date.first$area_m[1],
           height_diff = height - date.first$height[1],
           vol_change = height_diff*(area_diff/2))
  }
  
volumes <- matchups %>% group_by(name) %>%
  nest() %>%
  mutate(volCalcs = map(data, volChange)) %>%
  select(-data) %>%
  unnest(cols = c(volCalcs))


## Rating curve calculations to expand volume change to all the height measurements
filter <- dplyr::count(volumes, name) %>% filter(n<2)

fits <- volumes %>%
  filter(!name %in% filter$name) %>%
  group_by(name) %>%
  nest() %>%
  mutate(fit = map(data, function(df) lm(vol_change ~ height, data = df))) %>%
  select(-data)

volumes_fitted <- heights %>%
  nest(-name) %>%
  inner_join(fits) %>%
  mutate(vol_fit = map2(fit, data, ~predict(.x, newdata = .y) %>% unname())) %>%
  select(-fit) %>%
  unnest(cols = c(data, vol_fit))


write_csv(volumes_fitted, 'data/out/volumes_fitted_LS30.csv')
```

## Join the the areas and look at some timeseries

```{r}
areas <- read_csv('data/out/areas_munged_CC30.csv') %>%
  select(area = Reconstructed, sat, name, date = timestamp) %>%
  mutate(date = as_date(date))

volsLong <- volumes_fitted %>%
  full_join(areas) %>%
  #filter(area > 5) %>%
  select(name, area, date, height, vol_fit) %>%
  pivot_longer(c(area, height, vol_fit), names_to = 'Metric') %>%
  mutate(Metric = factor(Metric, levels = c('height', 'area', 'vol_fit')))

lake <- 'Salters Lake'

volsLong %>% filter(name == lake,  date > '2017-04-01') %>%
  ggplot(aes(x = date, y = value)) + geom_path() + geom_point()   +
  facet_wrap(~Metric, scales = 'free_y', ncol = 1) +
  ggtitle(lake)


```

## Compare to SB's volume outputs
```{r}
###
ids <- read_csv('data/in/lake_properties.csv')

volumes <- volumes %>% left_join(ids)

root <- 'data/in/Vols_Sarina/'

paths <- list.files('data/in/Vols_Sarina', pattern = '.csv')

Vols_SB <- map_dfr(paths, function(path) 
  read_csv(paste0(root,path)) %>% mutate(gauge_id = strsplit(path, '.csv') %>% first())
  )

id <- ids$gauge_id[9]

p1 <- volumes %>%
  filter(gauge_id == id) %>%
  ggplot(aes(x = date, y = vol_change)) + geom_point() +
  geom_line() + 
  ggtitle("Simon")

p2 <- Vols_SB %>%
  filter(gauge_id == id) %>%
  ggplot(aes(x = Date, y = ChangeInVolumem3)) + geom_point() +
  geom_line() +
  ggtitle('Sarina')

print(paste0('Simon: ', nrow(volumes %>% filter(gauge_id == id)),' Sarina: ',nrow(Vols_SB %>% filter(gauge_id == id))))

gridExtra::grid.arrange(p1,p2, nrow = 2)


check <- Vols_SB %>%
  filter(gauge_id == id)

```



## Compare to SB's rating curve outputs
```{r}
###
ids <- read_csv('data/in/lake_properties.csv')

volumes_fitted <- volumes_fitted %>% left_join(ids)

root <- 'data/in/rc_out_SB/'

paths <- list.files('data/in/rc_out_SB')

Vols_SB <- map_dfr(paths, function(path) 
  read_csv(paste0(root,path)) %>% mutate(gauge_id = strsplit(path, '_')[[1]][[1]] %>% first())
  )

id <- ids$gauge_id[11]

p1 <- volumes_fitted %>%
  filter(gauge_id == id) %>%
  ggplot(aes(x = date, y = vol_fit)) + geom_point() +
  geom_line() + 
  ggtitle("Simon")

p2 <- Vols_SB %>%
  filter(gauge_id == id) %>%
  ggplot(aes(x = Date, y = `^Volume(RC)`)) + geom_point() +
  geom_line() +
  ggtitle('Sarina')

print(paste0('Simon: ', nrow(volumes_fitted %>% filter(gauge_id == id)),' Sarina: ',nrow(Vols_SB %>% filter(gauge_id == id))))

gridExtra::grid.arrange(p1,p2, nrow = 2)


```


```{r}
hist(Vols_SB$Heightm[Vols_SB$gauge_id == 'SAN2'])
hist(volumes$height[volumes$gauge_id == 'SAN2'])


```

