---
title: "Lake Area Pulls"
author: "Simon Topp"
date: "7/23/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(reticulate)
library(googledrive)


```

## Python chunk for pulling Landsat Lake Surface Areas

```{python, engine.path = '/usr/local/bin/python2'}
#/usr/local/bin/python2

import ee
import time
ee.Initialize()

#Source necessary functions.
execfile('CitSciFuncs.py')

l8 = ee.ImageCollection('LANDSAT/LC08/C01/T1_RT_TOA')
l7 = ee.ImageCollection('LANDSAT/LE07/C01/T1_RT_TOA').filter(ee.Filter.date('1999-05-01', '2003-05-30'))
l5 = ee.ImageCollection('LANDSAT/LT05/C01/T1_TOA')

#Identify collection for use in sourced functions.
series = 'TOA'

#Standardize band names between the various collections and aggregate 
#them into one image collection

bn8 = ['B2','B3', 'B4', 'B5', 'B6','B7', 'BQA']
bn57 = ['B1', 'B2', 'B3', 'B4', 'B5','B7', 'BQA']
bns = ['Blue', 'Green', 'Red', 'Nir', 'Swir1', 'Swir2', 'qa']
  
ls5 = l5.select(bn57, bns)
ls7 = l7.select(bn57, bns)
ls8 = l8.select(bn8, bns)

ls = ee.ImageCollection(ls5.merge(ls7).merge(ls8))

#Script for Measuring and exporting Landsat Lake Areas

table1 = ee.FeatureCollection('users/sntopp/Lakes_ply_20171106')
table2 = ee.FeatureCollection('users/sntopp/NCSC_Horsepen_Lake')
table = table1.merge(table2)
lakeNum = int(table.size().getInfo())
lakes = table.toList(lakeNum) 

if series == 'SR':
  bitAffected = {
  'Cloud': [5, 1],
  'CloudShadow': [3, 1],
  'CirrusConfidence': [8,2], 
  'SnowIceConfidence': [9, 2]
    }

#Realized that sometimes super turbid waterbodies are flagged as snow/ice, subsequently you can't filter by this unless you know your area

if series == 'TOA':
  bitAffected = {
  'Cloud': [4, 1],
  'CloudShadow': [7, 2],
  'CirrusConfidence': [11,2],
  'SnowIceConfidence': [9, 2]
    }
  

for i in range(0,lakeNum):

  polygon = ee.Feature(lakes.get(i)).geometry()
    
  buff = polygon.buffer(2000)
    
  lakename = str(ee.Feature(lakes.get(i)).get('GNIS_NAME').getInfo())
    
  path = ee.Feature(lakes.get(i)).get('path').getInfo()
  row = ee.Feature(lakes.get(i)).get('row').getInfo()
    
  collection = ls.filterBounds(polygon)
  
  #Remove scene edges      
  #LSClip = collection.map(clipImage)
  
  #Remove partial lake images
  LSClip = filterToNonEmpty(collection, polygon, 30)
  
  #Clip to lake with 2000 meter buffer
  LSClip = LSClip.map(lakeClip)
        
  LSimageNoCloud = LSClip.map(lsCloudFilter).filter(ee.Filter.lt('cScore', 20))
    
  otsu = LSimageNoCloud.map(thresh)
  LSextent = otsu.map(waterExtentLS)
  #LSextent = LSimageNoCloud.map(waterExtentLS)
        
  output = ee.FeatureCollection(LSextent.map(out))
        
  LSExport = ee.batch.Export.table.toDrive(collection = output, \
                                          description = lakename, \
                                          folder='UNC_LakeAreasLS',\
                                          fileFormat = 'csv')
  #maximum_no_of_tasks(20, 30)
  #Send next task.
  LSExport.start()
  print('Done')


```

## Python chunk for Pulling Sentinel 2 Lake Surface Areas

```{python, engine.path = '/usr/local/bin/python2'}
import ee
import time
import math
ee.Initialize()

#Source necessary functions.
execfile('CitSciFuncs.py')

s2 = ee.ImageCollection('COPERNICUS/S2')

bitAffected = {
'Cloud': [10, 1],
'CirrusConfidence': [11,1], 
    }

#Identify collection for use in sourced functions.
series = 'S2'

#Identify projection of landsat 8

#Standardize band names between the various collections and aggregate 
#them into one image collection

bnS2 = ['B1','B2','B3','B4','B6','B8A','B9','B10', 'B11','B12', 'QA60']

bns = ['Aerosol', 'Blue', 'Green', 'Red', 'Red2','Red4','H2o', 'Cirrus','Swir1', 'Swir2', 'qa']
  
s2 = s2.map(scale)#Rescale to 0-1

#Script for Measuring and exporting Landsat Lake Areas

table1 = ee.FeatureCollection('users/sntopp/Lakes_ply_20171106')
table2 = ee.FeatureCollection('users/sntopp/NCSC_Horsepen_Lake')
table = table1.merge(table2)
lakeNum = int(table.size().getInfo())
lakes = table.toList(lakeNum) 

for i in range(0,lakeNum):

  polygon = ee.Feature(lakes.get(i)).geometry()
    
  buff = polygon.buffer(2000)
    
  lakename = str(ee.Feature(lakes.get(i)).get('GNIS_NAME').getInfo())
    
  path = ee.Feature(lakes.get(i)).get('path').getInfo()
  row = ee.Feature(lakes.get(i)).get('row').getInfo()
    
    
  collection = s2.filterBounds(polygon)
        
  #Remove scene edges      
  LSClip = collection.map(clipImage)
  
  #Remove partial lake images
  LSClip = filterToNonEmpty(LSClip, polygon, 30)
  
  #Clip to lake with 2000 meter buffer
  LSClip = LSClip.map(lakeClip)
        
  LSimageNoCloud = LSClip.map(lsCloudFilter).filter(ee.Filter.lt('cScore', 20))
  
  LSimageNoCloud = LSimageNoCloud.map(sentinelCloudScore).filter(ee.Filter.lt('cScoreII', 20))
    
  otsu = LSimageNoCloud.map(thresh)
  LSextent = otsu.map(waterExtentLS)
  #LSextent = LSimageNoCloud.map(waterExtentLS)
        
  output = ee.FeatureCollection(LSextent.map(out))
        
  LSExport = ee.batch.Export.table.toDrive(collection = output, \
                                          description = lakename, \
                                          folder='UNC_LakeAreasS2_cThresh',\
                                          fileFormat = 'csv')
  maximum_no_of_tasks(20, 30)
  #Send next task.
  LSExport.start()
  print('Done')

```